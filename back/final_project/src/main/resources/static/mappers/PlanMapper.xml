<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.floating.mvc.dao.PlanDao">

	<!-- Plan을 추가한다. -->
	<insert id="insertPlan" useGeneratedKeys="true" keyProperty="planPk">
		INSERT INTO plan(date, category, detail, time, complete_date, shifted, id)
		VALUES (
			#{plan.date}, 
			#{plan.category}, 
			#{plan.detail}, 
			#{plan.time}, 
			#{plan.completeDate}, 
			#{plan.shifted}, 
			#{userId}
		)
	</insert>
	
	<!-- 일주일치 계획을 추가한다 -->
	<insert id="insertPlanBatch" parameterType="java.util.List">
	    INSERT INTO plan (
	        date, 
	        category, 
	        detail, 
	        time, 
	        shifted, 
	        user_id
	    ) VALUES 
	    <foreach collection="plans" item="item" separator=",">
	    (
	        #{item.date}, 
	        #{item.category}, 
	        #{item.detail}, 
	        #{item.time}, 
	        0, 
	        #{item.userId}
	    )
	    </foreach>
	</insert>

	<!-- Plan 정보 전체를 조회한다. -->
	<select id="selectAll">
		SELECT * FROM plan
		WHERE user_id = #{userId}
	</select>
	
	<!-- Plan 정보 일부를 조회한다. -->
	<select id="selectPlan" resultType="PlanRequestDto">
		SELECT * FROM plan 
		WHERE plan_pk = #{planPk} AND user_id = #{userId}
		
	</select>
	
	<!-- Plan 정보를 수정한다. -->
	<update id="updatePlan">
		UPDATE plan
		SET
			date = #{date},
			category = #{category},
			detail = #{detail},
			time = #{time},
			complete_date = #{completeDate},
			shifted = #{shifted}
		WHERE plan_pk = #{planPk}
	</update>
	
	<!-- Plan 완료를 진행한다. -->
	<update id="postPlanCompl">
		UPDATE plan
		SET
			complete_date = #{completeDate}
		WHERE plan_pk = #{planPk}
	</update>
	
	<!-- Plan 완료를 진행한다. -->
	<update id="postPlanUncompl">
		UPDATE plan
		SET
			complete_date = null
		WHERE plan_pk = #{planPk}
	</update>
	
	<!-- 지난 주 계획을 복사하여 이번주 계획으로 추가한다. -->
	<insert id="insertWeeklyPlan">
		INSERT INTO plan (user_id, date, category, detail, time, complete_date, shifted)
		    SELECT 
		        user_id,
		        DATE_ADD(date, INTERVAL 7 DAY),
		        category,
		        detail,
		        time,
		        NULL,
		        CASE 
		            WHEN complete_date IS NULL THEN shifted + 1
		            ELSE 0
		        END
		    FROM plan
		    WHERE user_id = #{userId}
		      AND date &gt;= DATE_SUB(CURDATE(), INTERVAL (DAYOFWEEK(CURDATE()) - 2) DAY) - INTERVAL 7 DAY
		      AND date &lt; DATE_SUB(CURDATE(), INTERVAL (DAYOFWEEK(CURDATE()) - 2) DAY)
	</insert>
	
	<!-- 오늘 계획을 복사하여 내일 계획으로 추가한다. -->
	<insert id="insertTomorrowPlan">
	    INSERT INTO plan (user_id, date, category, detail, time, complete_date, shifted)
	    SELECT 
	        user_id,
	        DATE_ADD(date, INTERVAL 1 DAY), 
	        category,
	        detail,
	        time,
	        NULL, 
	        shifted + 1
	    FROM plan
	    WHERE user_id = #{userId}
	      AND date = CURDATE()     
	</insert>
	
	<!-- 오늘 계획을 삭제한다. -->
	<delete id="deleteTodayPlan">
	    DELETE FROM plan
	    WHERE user_id = #{userId}
	      AND date = CURDATE()
	      AND complete_date IS NULL
	</delete>
	
	
</mapper>